<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Oracle AI Tutor</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-100">
    <div class="max-w-3xl mx-auto py-8 px-4">
      <h1 class="text-3xl font-bold mb-4 text-center">Oracle AI Tutor</h1>

      <div id="chatBox"
           class="bg-white p-4 h-[450px] overflow-y-auto rounded shadow mb-3">
      </div>

      <div id="status" class="text-sm text-gray-500 mb-2"></div>

      <div class="flex gap-2">
        <input id="questionInput"
               class="flex-1 border rounded p-3"
               placeholder="Ask a question about the course..." />
        <button id="sendBtn"
                class="bg-blue-600 text-white px-5 py-3 rounded hover:bg-blue-700">
          Ask
        </button>
      </div>
    </div>

    <script>
      const chatBox = document.getElementById("chatBox");
      const statusEl = document.getElementById("status");
      const questionInput = document.getElementById("questionInput");
      const sendBtn = document.getElementById("sendBtn");

      function addMessage(role, text) {
        const div = document.createElement("div");
        const bg = role === "user" ? "bg-green-100" : "bg-blue-50";
        const who = role === "user" ? "You" : "Tutor";

        div.className = `mb-3 p-3 rounded ${bg}`;
        div.innerHTML = `<strong>${who}:</strong><br><pre class="whitespace-pre-wrap">${text}</pre>`;
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
      }

      function addSources(sources) {
        if (!sources || !sources.length) return;
        const wrapper = document.createElement("details");
        wrapper.className = "mb-3 p-3 rounded bg-gray-50";

        const summary = document.createElement("summary");
        summary.className = "cursor-pointer font-semibold";
        summary.textContent = "Sources used";
        wrapper.appendChild(summary);

        sources.forEach((s) => {
          const d = document.createElement("div");
          d.className = "mt-2 text-sm";
          d.innerHTML =
            `<b>ID ${s.id}</b> (${s.source_uri}, score=${s.score.toFixed(4)})<br>` +
            `${s.preview}`;
          wrapper.appendChild(d);
        });

        chatBox.appendChild(wrapper);
        chatBox.scrollTop = chatBox.scrollHeight;
      }

      async function send() {
        const q = questionInput.value.trim();
        if (!q) return;

        addMessage("user", q);
        questionInput.value = "";
        statusEl.textContent = "Thinking...";

        try {
              const res = await fetch("http://localhost:5000/answer", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              question: q,
              course: "DATA100_FALL25",
              k: 5
            }),
          });

          if (!res.ok) {
            const text = await res.text();
            throw new Error(`HTTP ${res.status}: ${text}`);
          }

          const data = await res.json();
          addMessage("assistant", data.answer);
          addSources(data.sources);
          statusEl.textContent = "";
        } catch (err) {
          console.error(err);
          statusEl.textContent = "Error: " + err.message;
        }
      }

      sendBtn.addEventListener("click", send);
      questionInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") send();
      });
    </script>
  </body>
</html>